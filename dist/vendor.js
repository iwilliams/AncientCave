function RC4(e){this.s=new Array(256),this.i=0,this.j=0;for(var t=0;256>t;t++)this.s[t]=t;e&&this.mix(e)}function RNG(e){null==e?e=(Math.random()+Date.now()).toString():"function"==typeof e?(this.uniform=e,this.nextByte=function(){return~~(256*this.uniform())},e=null):"[object String]"!==Object.prototype.toString.call(e)&&(e=JSON.stringify(e)),this._normal=null,e?this._state=new RC4(e):this._state=null}(function(){var e,t,n,i,r,o,s,a,c,u,h,p,l,d,f,_,y,v,g,m={}.hasOwnProperty,k=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};o={is_unordered:!1,is_counting:!1,is_exclusive:!1,is_solitary:!1,prevent_default:!1,prevent_repeat:!1},v="meta alt option ctrl shift cmd".split(" "),_="ctrl",e={debug:!1};var b=function(e){var t,n;for(t in e)m.call(e,t)&&(n=e[t],!1!==n&&(this[t]=n));this.keys=this.keys||[],this.count=this.count||0};b.prototype.allows_key_repeat=function(){return!this.prevent_repeat&&"function"==typeof this.on_keydown},b.prototype.reset=function(){return this.count=0,this.keyup_fired=null};var w=function(e,t){var n,i;"undefined"!=typeof jQuery&&null!==jQuery&&e instanceof jQuery&&(1!==e.length&&f("Warning: your jQuery selector should have exactly one object."),e=e[0]),this.should_force_event_defaults=this.should_suppress_event_defaults=!1,this.sequence_delay=800,this._registered_combos=[],this._keys_down=[],this._active_combos=[],this._sequence=[],this._sequence_timer=null,this._prevent_capture=!1,this._defaults=t||{};for(n in o)m.call(o,n)&&(i=o[n],this._defaults[n]=this._defaults[n]||i);this.element=e||document.body,n=function(e,t,n){return e.addEventListener?e.addEventListener(t,n):e.attachEvent&&e.attachEvent("on"+t,n),n};var r=this;this.keydown_event=n(this.element,"keydown",function(e){return e=e||window.event,r._receive_input(e,!0),r._bug_catcher(e)});var s=this;this.keyup_event=n(this.element,"keyup",function(e){return e=e||window.event,s._receive_input(e,!1)});var a=this;this.blur_event=n(window,"blur",function(){var e,t,n,i;for(i=a._keys_down,t=0,n=i.length;n>t;t++)e=i[t],a._key_up(e,{});return a._keys_down=[]})};w.prototype.destroy=function(){var e;return e=function(e,t,n){return null!=e.removeEventListener?e.removeEventListener(t,n):null!=e.removeEvent?e.removeEvent("on"+t,n):void 0},e(this.element,"keydown",this.keydown_event),e(this.element,"keyup",this.keyup_event),e(window,"blur",this.blur_event)},w.prototype._bug_catcher=function(e){var t;return"cmd"===_&&0<=k.call(this._keys_down,"cmd")&&"cmd"!==(t=i(e.keyCode))&&"shift"!==t&&"alt"!==t&&"caps"!==t&&"tab"!==t?this._receive_input(e,!1):void 0},w.prototype._cmd_bug_check=function(e){return"cmd"===_&&0<=k.call(this._keys_down,"cmd")&&0>k.call(e,"cmd")?!1:!0},w.prototype._prevent_default=function(e,t){return(t||this.should_suppress_event_defaults)&&!this.should_force_event_defaults&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation)?e.stopPropagation():void 0},w.prototype._get_active_combos=function(e){var t,n;return t=[],n=s(this._keys_down,function(t){return t!==e}),n.push(e),this._match_combo_arrays(n,function(e){return function(n){return e._cmd_bug_check(n.keys)?t.push(n):void 0}}(this)),this._fuzzy_match_combo_arrays(n,function(e){return function(n){return 0<=k.call(t,n)||n.is_solitary||!e._cmd_bug_check(n.keys)?void 0:t.push(n)}}(this)),t},w.prototype._get_potential_combos=function(e){var t,n,i,r,o;for(n=[],o=this._registered_combos,i=0,r=o.length;r>i;i++)t=o[i],t.is_sequence||0<=k.call(t.keys,e)&&this._cmd_bug_check(t.keys)&&n.push(t);return n},w.prototype._add_to_active_combos=function(e){var t,n,i,r,o,s,a,c,u,h,p;if(s=!1,o=!0,i=!1,0<=k.call(this._active_combos,e))return!0;if(this._active_combos.length)for(r=a=0,h=this._active_combos.length;h>=0?h>a:a>h;r=h>=0?++a:--a)if((t=this._active_combos[r])&&t.is_exclusive&&e.is_exclusive){if(t=t.keys,!s)for(c=0,u=t.length;u>c;c++)if(n=t[c],s=!0,0>k.call(e.keys,n)){s=!1;break}if(o&&!s)for(p=e.keys,c=0,u=p.length;u>c;c++)if(n=p[c],o=!1,0>k.call(t,n)){o=!0;break}s&&(i?(t=this._active_combos.splice(r,1)[0],null!=t&&t.reset()):(t=this._active_combos.splice(r,1,e)[0],null!=t&&t.reset(),i=!0),o=!1)}return o&&this._active_combos.unshift(e),s||o},w.prototype._remove_from_active_combos=function(e){var t,n,i,r;for(n=i=0,r=this._active_combos.length;r>=0?r>i:i>r;n=r>=0?++i:--i)if(t=this._active_combos[n],t===e){e=this._active_combos.splice(n,1)[0],e.reset();break}},w.prototype._get_possible_sequences=function(){var e,t,n,i,r,o,a,c,u,h,p,l;for(i=[],h=this._registered_combos,o=0,u=h.length;u>o;o++)for(e=h[o],t=a=1,p=this._sequence.length;p>=1?p>=a:a>=p;t=p>=1?++a:--a)if(r=this._sequence.slice(-t),e.is_sequence){if(0>k.call(e.keys,"shift")&&(r=s(r,function(e){return"shift"!==e}),!r.length))continue;for(t=c=0,l=r.length;l>=0?l>c:c>l;t=l>=0?++c:--c){if(e.keys[t]!==r[t]){n=!1;break}n=!0}n&&i.push(e)}return i},w.prototype._add_key_to_sequence=function(e,t){var n,i,r,o;if(this._sequence.push(e),i=this._get_possible_sequences(),i.length){for(r=0,o=i.length;o>r;r++)n=i[r],this._prevent_default(t,n.prevent_default);this._sequence_timer&&clearTimeout(this._sequence_timer),-1<this.sequence_delay&&(this._sequence_timer=setTimeout(function(){return this._sequence=[]},this.sequence_delay))}else this._sequence=[]},w.prototype._get_sequence=function(e){var t,n,i,r,o,a,c,u,h,p,l,d;for(p=this._registered_combos,a=0,h=p.length;h>a;a++)if(t=p[a],t.is_sequence){for(n=c=1,l=this._sequence.length;l>=1?l>=c:c>=l;n=l>=1?++c:--c)if(o=s(this._sequence,function(e){return 0<=k.call(t.keys,"shift")?!0:"shift"!==e}).slice(-n),t.keys.length===o.length)for(n=u=0,d=o.length;d>=0?d>u:u>d;n=d>=0?++u:--u)if(r=o[n],!(0>k.call(t.keys,"shift")&&"shift"===r||"shift"===e&&0>k.call(t.keys,"shift"))){if(t.keys[n]!==r){i=!1;break}i=!0}if(i)return t.is_exclusive&&(this._sequence=[]),t}return!1},w.prototype._receive_input=function(e,t){var n;if(this._prevent_capture)this._keys_down.length&&(this._keys_down=[]);else if(n=i(e.keyCode),(t||this._keys_down.length||!("alt"===n||n===_))&&n)return t?this._key_down(n,e):this._key_up(n,e)},w.prototype._fire=function(e,t,n,i){return"function"==typeof t["on_"+e]&&this._prevent_default(n,!0!==t["on_"+e].call(t["this"],n,t.count,i)),"release"===e&&(t.count=0),"keyup"===e?t.keyup_fired=!0:void 0},w.prototype._match_combo_arrays=function(e,i){var r,o,s,a;for(a=this._registered_combos,o=0,s=a.length;s>o;o++)r=a[o],(!r.is_unordered&&n(e,r.keys)||r.is_unordered&&t(e,r.keys))&&i(r)},w.prototype._fuzzy_match_combo_arrays=function(e,t){var n,i,r,o;for(o=this._registered_combos,i=0,r=o.length;r>i;i++)n=o[i],(!n.is_unordered&&u(n.keys,e)||n.is_unordered&&c(n.keys,e))&&t(n)},w.prototype._keys_remain=function(e){var t,n,i,r;for(r=e.keys,n=0,i=r.length;i>n;n++)if(e=r[n],0<=k.call(this._keys_down,e)){t=!0;break}return t},w.prototype._key_down=function(e,t){var n,i,o,s,a;(n=r(e,t))&&(e=n),this._add_key_to_sequence(e,t),(n=this._get_sequence(e))&&this._fire("keydown",n,t);for(o in y)n=y[o],t[n]&&(o===e||0<=k.call(this._keys_down,o)||this._keys_down.push(o));for(o in y)if(n=y[o],o!==e&&0<=k.call(this._keys_down,o)&&!t[n]&&!("cmd"===o&&"cmd"!==_))for(n=i=0,s=this._keys_down.length;s>=0?s>i:i>s;n=s>=0?++i:--i)this._keys_down[n]===o&&this._keys_down.splice(n,1);for(i=this._get_active_combos(e),o=this._get_potential_combos(e),s=0,a=i.length;a>s;s++)n=i[s],this._handle_combo_down(n,o,e,t);if(o.length)for(i=0,s=o.length;s>i;i++)n=o[i],this._prevent_default(t,n.prevent_default);0>k.call(this._keys_down,e)&&this._keys_down.push(e)},w.prototype._handle_combo_down=function(e,t,n,i){var r,o,s,a,c;if(0>k.call(e.keys,n))return!1;if(this._prevent_default(i,e&&e.prevent_default),r=!1,0<=k.call(this._keys_down,n)&&(r=!0,!e.allows_key_repeat()))return!1;if(s=this._add_to_active_combos(e,n),n=e.keyup_fired=!1,e.is_exclusive)for(a=0,c=t.length;c>a;a++)if(o=t[a],o.is_exclusive&&o.keys.length>e.keys.length){n=!0;break}return!n&&(e.is_counting&&"function"==typeof e.on_keydown&&(e.count+=1),s)?this._fire("keydown",e,i,r):void 0},w.prototype._key_up=function(e,t){var n,i,o,s,a,c;if(n=e,(o=r(e,t))&&(e=o),o=d[n],t.shiftKey?o&&0<=k.call(this._keys_down,o)||(e=n):n&&0<=k.call(this._keys_down,n)||(e=o),(s=this._get_sequence(e))&&this._fire("keyup",s,t),0>k.call(this._keys_down,e))return!1;for(s=a=0,c=this._keys_down.length;c>=0?c>a:a>c;s=c>=0?++a:--a)if((i=this._keys_down[s])===e||i===o||i===n){this._keys_down.splice(s,1);break}for(i=this._active_combos.length,o=[],c=this._active_combos,s=0,a=c.length;a>s;s++)n=c[s],0<=k.call(n.keys,e)&&o.push(n);for(s=0,a=o.length;a>s;s++)n=o[s],this._handle_combo_up(n,t,e);if(i>1)for(a=this._active_combos,i=0,s=a.length;s>i;i++)n=a[i],void 0===n||0<=k.call(o,n)||this._keys_remain(n)||this._remove_from_active_combos(n)},w.prototype._handle_combo_up=function(e,n,i){var r,o;this._prevent_default(n,e&&e.prevent_default),o=this._keys_remain(e),e.keyup_fired||(r=this._keys_down.slice(),r.push(i),e.is_solitary&&!t(r,e.keys))||(this._fire("keyup",e,n),e.is_counting&&"function"==typeof e.on_keyup&&"function"!=typeof e.on_keydown&&(e.count+=1)),o||(this._fire("release",e,n),this._remove_from_active_combos(e))},w.prototype.simple_combo=function(e,t){return this.register_combo({keys:e,on_keydown:t})},w.prototype.counting_combo=function(e,t){return this.register_combo({keys:e,is_counting:!0,is_unordered:!1,on_keydown:t})},w.prototype.sequence_combo=function(e,t){return this.register_combo({keys:e,on_keydown:t,is_sequence:!0,is_exclusive:!0})},w.prototype.register_combo=function(e){var t,n,i;"string"==typeof e.keys&&(e.keys=e.keys.split(" ")),i=this._defaults;for(t in i)m.call(i,t)&&(n=i[t],void 0===e[t]&&(e[t]=n));return e=new b(e),g(e)?(this._registered_combos.push(e),e):void 0},w.prototype.register_many=function(e){var t,n,i,r;for(r=[],n=0,i=e.length;i>n;n++)t=e[n],r.push(this.register_combo(t));return r},w.prototype.unregister_combo=function(e){var i,r,o,s,a,c;if(!e)return!1;var u=this;if(r=function(e){var t,n,i,r;for(r=[],t=n=0,i=u._registered_combos.length;i>=0?i>n:n>i;t=i>=0?++n:--n){if(e===u._registered_combos[t]){u._registered_combos.splice(t,1);break}r.push(void 0)}return r},e instanceof b)return r(e);for("string"==typeof e&&(e=e.split(" ")),a=this._registered_combos,c=[],o=0,s=a.length;s>o;o++)i=a[o],null!=i&&(i.is_unordered&&t(e,i.keys)||!i.is_unordered&&n(e,i.keys)?c.push(r(i)):c.push(void 0));return c},w.prototype.unregister_many=function(e){var t,n,i,r;for(r=[],n=0,i=e.length;i>n;n++)t=e[n],r.push(this.unregister_combo(t));return r},w.prototype.get_registered_combos=function(){return this._registered_combos},w.prototype.reset=function(){return this._registered_combos=[]},w.prototype.listen=function(){return this._prevent_capture=!1},w.prototype.stop_listening=function(){return this._prevent_capture=!0},w.prototype.get_meta_key=function(){return _},e.Listener=w,i=function(e){return l[e]},s=function(e,t){var n;if(e.filter)return e.filter(t);var i,r,o;for(o=[],i=0,r=e.length;r>i;i++)n=e[i],t(n)&&o.push(n);return o},t=function(e,t){var n,i,r;if(e.length!==t.length)return!1;for(i=0,r=e.length;r>i;i++)if(n=e[i],!(0<=k.call(t,n)))return!1;return!0},n=function(e,t){var n,i,r;if(e.length!==t.length)return!1;for(n=i=0,r=e.length;r>=0?r>i:i>r;n=r>=0?++i:--i)if(e[n]!==t[n])return!1;return!0},c=function(e,t){var n,i,r;for(i=0,r=e.length;r>i;i++)if(n=e[i],0>k.call(t,n))return!1;return!0},a=Array.prototype.indexOf||function(e,t){var n,i,r;for(n=i=0,r=e.length;r>=0?r>=i:i>=r;n=r>=0?++i:--i)if(e[n]===t)return n;return-1},u=function(e,t){var n,i,r,o;for(r=i=0,o=e.length;o>r;r++){if(n=e[r],n=a.call(t,n),!(n>=i))return!1;i=n}return!0},f=function(){return e.debug?console.log.apply(console,arguments):void 0},h=function(e){var t,n,i;t=!1;for(i in l)if(n=l[i],e===n){t=!0;break}if(!t)for(i in d)if(n=d[i],e===n){t=!0;break}return t},g=function(e){var t,n,i,r,s,c,u;for(s=!0,e.keys.length||f("You're trying to bind a combo with no keys:",e),n=c=0,u=e.keys.length;u>=0?u>c:c>u;n=u>=0?++c:--c)i=e.keys[n],(t=p[i])&&(i=e.keys[n]=t),"meta"===i&&e.keys.splice(n,1,_),"cmd"===i&&f('Warning: use the "meta" key rather than "cmd" for Windows compatibility');for(u=e.keys,t=0,c=u.length;c>t;t++)i=u[t],h(i)||(f('Do not recognize the key "'+i+'"'),s=!1);if(0<=k.call(e.keys,"meta")||0<=k.call(e.keys,"cmd")){for(t=e.keys.slice(),c=0,u=v.length;u>c;c++)i=v[c],-1<(n=a.call(t,i))&&t.splice(n,1);1<t.length&&(f("META and CMD key combos cannot have more than 1 non-modifier keys",e,t),s=!1)}for(r in e)"undefined"===o[r]&&f("The property "+r+" is not a valid combo property. Your combo has still been registered.");return s},r=function(e,t){var n;return t.shiftKey?(n=d[e],null!=n?n:!1):!1},y={cmd:"metaKey",ctrl:"ctrlKey",shift:"shiftKey",alt:"altKey"},p={escape:"esc",control:"ctrl",command:"cmd","break":"pause",windows:"cmd",option:"alt",caps_lock:"caps",apostrophe:"'",semicolon:";",tilde:"~",accent:"`",scroll_lock:"scroll",num_lock:"num"},d={"/":"?",".":">",",":"<","'":'"',";":":","[":"{","]":"}","\\":"|","`":"~","=":"+","-":"_",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")"},l={0:"\\",8:"backspace",9:"tab",12:"num",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"caps",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"print",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"cmd",92:"cmd",93:"cmd",96:"num_0",97:"num_1",98:"num_2",99:"num_3",100:"num_4",101:"num_5",102:"num_6",103:"num_7",104:"num_8",105:"num_9",106:"num_multiply",107:"num_add",108:"num_enter",109:"num_subtract",110:"num_decimal",111:"num_divide",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",124:"print",144:"num",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",223:"`",224:"cmd",225:"alt",57392:"ctrl",63289:"num",59:";",61:"=",173:"-"},e._keycode_dictionary=l,e._is_array_in_array_sorted=u,-1!==navigator.userAgent.indexOf("Mac OS X")&&(_="cmd"),-1!==navigator.userAgent.indexOf("Opera")&&(l[17]="cmd"),"function"==typeof define&&define.amd?define([],function(){return e}):"undefined"!=typeof exports&&null!==exports?exports.keypress=e:window.keypress=e}).call(this),!function e(t,n,i){function r(s,a){if(!n[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var h=n[s]={exports:{}};t[s][0].call(h.exports,function(e){var n=t[s][1][e];return r(n?n:e)},h,h.exports,e,t,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(e,t){t.exports.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,t.exports.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,t.exports.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate},{}],2:[function(e,t){function n(e,t,s){return this instanceof n?(r.call(this),this.options=i.extend({serialization:"binary",reliable:!1},s),this.open=!1,this.type="data",this.peer=e,this.provider=t,this.id=this.options.connectionId||n._idPrefix+i.randomToken(),this.label=this.options.label||this.id,this.metadata=this.options.metadata,this.serialization=this.options.serialization,this.reliable=this.options.reliable,this._buffer=[],this._buffering=!1,this.bufferSize=0,this._chunkedData={},this.options._payload&&(this._peerBrowser=this.options._payload.browser),void o.startConnection(this,this.options._payload||{originator:!0})):new n(e,t,s)}var i=e("./util"),r=e("eventemitter3"),o=e("./negotiator"),s=e("reliable");i.inherits(n,r),n._idPrefix="dc_",n.prototype.initialize=function(e){this._dc=this.dataChannel=e,this._configureDataChannel()},n.prototype._configureDataChannel=function(){var e=this;i.supports.sctp&&(this._dc.binaryType="arraybuffer"),this._dc.onopen=function(){i.log("Data channel connection success"),e.open=!0,e.emit("open")},!i.supports.sctp&&this.reliable&&(this._reliable=new s(this._dc,i.debug)),this._reliable?this._reliable.onmessage=function(t){e.emit("data",t)}:this._dc.onmessage=function(t){e._handleDataMessage(t)},this._dc.onclose=function(){i.log("DataChannel closed for:",e.peer),e.close()}},n.prototype._handleDataMessage=function(e){var t=this,n=e.data,r=n.constructor;if("binary"===this.serialization||"binary-utf8"===this.serialization){if(r===Blob)return void i.blobToArrayBuffer(n,function(e){n=i.unpack(e),t.emit("data",n)});if(r===ArrayBuffer)n=i.unpack(n);else if(r===String){var o=i.binaryStringToArrayBuffer(n);n=i.unpack(o)}}else"json"===this.serialization&&(n=JSON.parse(n));if(n.__peerData){var s=n.__peerData,a=this._chunkedData[s]||{data:[],count:0,total:n.total};return a.data[n.n]=n.data,a.count+=1,a.total===a.count&&(delete this._chunkedData[s],n=new Blob(a.data),this._handleDataMessage({data:n})),void(this._chunkedData[s]=a)}this.emit("data",n)},n.prototype.close=function(){this.open&&(this.open=!1,o.cleanup(this),this.emit("close"))},n.prototype.send=function(e,t){if(!this.open)return void this.emit("error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));if(this._reliable)return void this._reliable.send(e);var n=this;if("json"===this.serialization)this._bufferedSend(JSON.stringify(e));else if("binary"===this.serialization||"binary-utf8"===this.serialization){var r=i.pack(e),o=i.chunkedBrowsers[this._peerBrowser]||i.chunkedBrowsers[i.browser];if(o&&!t&&r.size>i.chunkedMTU)return void this._sendChunks(r);i.supports.sctp?i.supports.binaryBlob?this._bufferedSend(r):i.blobToArrayBuffer(r,function(e){n._bufferedSend(e)}):i.blobToBinaryString(r,function(e){n._bufferedSend(e)})}else this._bufferedSend(e)},n.prototype._bufferedSend=function(e){(this._buffering||!this._trySend(e))&&(this._buffer.push(e),this.bufferSize=this._buffer.length)},n.prototype._trySend=function(e){try{this._dc.send(e)}catch(t){this._buffering=!0;var n=this;return setTimeout(function(){n._buffering=!1,n._tryBuffer()},100),!1}return!0},n.prototype._tryBuffer=function(){if(0!==this._buffer.length){var e=this._buffer[0];this._trySend(e)&&(this._buffer.shift(),this.bufferSize=this._buffer.length,this._tryBuffer())}},n.prototype._sendChunks=function(e){for(var t=i.chunk(e),n=0,r=t.length;r>n;n+=1){var e=t[n];this.send(e,!0)}},n.prototype.handleMessage=function(e){var t=e.payload;switch(e.type){case"ANSWER":this._peerBrowser=t.browser,o.handleSDP(e.type,this,t.sdp);break;case"CANDIDATE":o.handleCandidate(this,t.candidate);break;default:i.warn("Unrecognized message type:",e.type,"from peer:",this.peer)}},t.exports=n},{"./negotiator":5,"./util":8,eventemitter3:9,reliable:12}],3:[function(e){window.Socket=e("./socket"),window.MediaConnection=e("./mediaconnection"),window.DataConnection=e("./dataconnection"),window.Peer=e("./peer"),window.RTCPeerConnection=e("./adapter").RTCPeerConnection,window.RTCSessionDescription=e("./adapter").RTCSessionDescription,window.RTCIceCandidate=e("./adapter").RTCIceCandidate,window.Negotiator=e("./negotiator"),window.util=e("./util"),window.BinaryPack=e("js-binarypack")},{"./adapter":1,"./dataconnection":2,"./mediaconnection":4,"./negotiator":5,"./peer":6,"./socket":7,"./util":8,"js-binarypack":10}],4:[function(e,t){function n(e,t,s){return this instanceof n?(r.call(this),this.options=i.extend({},s),this.open=!1,this.type="media",this.peer=e,this.provider=t,this.metadata=this.options.metadata,this.localStream=this.options._stream,this.id=this.options.connectionId||n._idPrefix+i.randomToken(),void(this.localStream&&o.startConnection(this,{_stream:this.localStream,originator:!0}))):new n(e,t,s)}var i=e("./util"),r=e("eventemitter3"),o=e("./negotiator");i.inherits(n,r),n._idPrefix="mc_",n.prototype.addStream=function(e){i.log("Receiving stream",e),this.remoteStream=e,this.emit("stream",e)},n.prototype.handleMessage=function(e){var t=e.payload;switch(e.type){case"ANSWER":o.handleSDP(e.type,this,t.sdp),this.open=!0;break;case"CANDIDATE":o.handleCandidate(this,t.candidate);break;default:i.warn("Unrecognized message type:",e.type,"from peer:",this.peer)}},n.prototype.answer=function(e){if(this.localStream)return void i.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");this.options._payload._stream=e,this.localStream=e,o.startConnection(this,this.options._payload);for(var t=this.provider._getMessages(this.id),n=0,r=t.length;r>n;n+=1)this.handleMessage(t[n]);this.open=!0},n.prototype.close=function(){this.open&&(this.open=!1,o.cleanup(this),this.emit("close"))},t.exports=n},{"./negotiator":5,"./util":8,eventemitter3:9}],5:[function(e,t){var n=e("./util"),i=e("./adapter").RTCPeerConnection,r=e("./adapter").RTCSessionDescription,o=e("./adapter").RTCIceCandidate,s={pcs:{data:{},media:{}},queue:[]};s._idPrefix="pc_",s.startConnection=function(e,t){var i=s._getPeerConnection(e,t);if("media"===e.type&&t._stream&&i.addStream(t._stream),e.pc=e.peerConnection=i,t.originator){if("data"===e.type){var r={};n.supports.sctp||(r={reliable:t.reliable});var o=i.createDataChannel(e.label,r);e.initialize(o)}n.supports.onnegotiationneeded||s._makeOffer(e)}else s.handleSDP("OFFER",e,t.sdp)},s._getPeerConnection=function(e,t){s.pcs[e.type]||n.error(e.type+" is not a valid connection type. Maybe you overrode the `type` property somewhere."),s.pcs[e.type][e.peer]||(s.pcs[e.type][e.peer]={});var i;return s.pcs[e.type][e.peer],t.pc&&(i=s.pcs[e.type][e.peer][t.pc]),i&&"stable"===i.signalingState||(i=s._startPeerConnection(e)),i},s._startPeerConnection=function(e){n.log("Creating RTCPeerConnection.");var t=s._idPrefix+n.randomToken(),r={};"data"!==e.type||n.supports.sctp?"media"===e.type&&(r={optional:[{DtlsSrtpKeyAgreement:!0}]}):r={optional:[{RtpDataChannels:!0}]};var o=new i(e.provider.options.config,r);return s.pcs[e.type][e.peer][t]=o,s._setupListeners(e,o,t),o},s._setupListeners=function(e,t){var i=e.peer,r=e.id,o=e.provider;n.log("Listening for ICE candidates."),t.onicecandidate=function(t){t.candidate&&(n.log("Received ICE candidates for:",e.peer),o.socket.send({type:"CANDIDATE",payload:{candidate:t.candidate,type:e.type,connectionId:e.id},dst:i}))},t.oniceconnectionstatechange=function(){switch(t.iceConnectionState){case"disconnected":case"failed":n.log("iceConnectionState is disconnected, closing connections to "+i),e.close();break;case"completed":t.onicecandidate=n.noop}},t.onicechange=t.oniceconnectionstatechange,n.log("Listening for `negotiationneeded`"),t.onnegotiationneeded=function(){n.log("`negotiationneeded` triggered"),"stable"==t.signalingState?s._makeOffer(e):n.log("onnegotiationneeded triggered when not stable. Is another connection being established?")},n.log("Listening for data channel"),t.ondatachannel=function(e){n.log("Received data channel");var t=e.channel,s=o.getConnection(i,r);s.initialize(t)},n.log("Listening for remote stream"),t.onaddstream=function(e){n.log("Received remote stream");var t=e.stream,s=o.getConnection(i,r);"media"===s.type&&s.addStream(t)}},s.cleanup=function(e){n.log("Cleaning up PeerConnection to "+e.peer);var t=e.pc;!t||"closed"===t.readyState&&"closed"===t.signalingState||(t.close(),e.pc=null)},s._makeOffer=function(e){var t=e.pc;t.createOffer(function(i){n.log("Created offer."),!n.supports.sctp&&"data"===e.type&&e.reliable&&(i.sdp=Reliable.higherBandwidthSDP(i.sdp)),t.setLocalDescription(i,function(){n.log("Set localDescription: offer","for:",e.peer),e.provider.socket.send({type:"OFFER",payload:{sdp:i,type:e.type,label:e.label,connectionId:e.id,reliable:e.reliable,serialization:e.serialization,metadata:e.metadata,browser:n.browser},dst:e.peer})},function(t){e.provider.emitError("webrtc",t),n.log("Failed to setLocalDescription, ",t)})},function(t){e.provider.emitError("webrtc",t),n.log("Failed to createOffer, ",t)},e.options.constraints)},s._makeAnswer=function(e){var t=e.pc;t.createAnswer(function(i){n.log("Created answer."),!n.supports.sctp&&"data"===e.type&&e.reliable&&(i.sdp=Reliable.higherBandwidthSDP(i.sdp)),t.setLocalDescription(i,function(){n.log("Set localDescription: answer","for:",e.peer),e.provider.socket.send({type:"ANSWER",payload:{sdp:i,type:e.type,connectionId:e.id,browser:n.browser},dst:e.peer})},function(t){e.provider.emitError("webrtc",t),n.log("Failed to setLocalDescription, ",t)})},function(t){e.provider.emitError("webrtc",t),n.log("Failed to create answer, ",t)})},s.handleSDP=function(e,t,i){i=new r(i);var o=t.pc;n.log("Setting remote description",i),o.setRemoteDescription(i,function(){n.log("Set remoteDescription:",e,"for:",t.peer),"OFFER"===e&&s._makeAnswer(t)},function(e){t.provider.emitError("webrtc",e),n.log("Failed to setRemoteDescription, ",e)})},s.handleCandidate=function(e,t){var i=t.candidate,r=t.sdpMLineIndex;e.pc.addIceCandidate(new o({sdpMLineIndex:r,candidate:i})),n.log("Added ICE candidate for:",e.peer)},t.exports=s},{"./adapter":1,"./util":8}],6:[function(e,t){function n(e,t){return this instanceof n?(r.call(this),e&&e.constructor==Object?(t=e,e=void 0):e&&(e=e.toString()),t=i.extend({debug:0,host:i.CLOUD_HOST,port:i.CLOUD_PORT,key:"peerjs",path:"/",token:i.randomToken(),config:i.defaultConfig},t),this.options=t,"/"===t.host&&(t.host=window.location.hostname),"/"!==t.path[0]&&(t.path="/"+t.path),"/"!==t.path[t.path.length-1]&&(t.path+="/"),void 0===t.secure&&t.host!==i.CLOUD_HOST&&(t.secure=i.isSecure()),t.logFunction&&i.setLogFunction(t.logFunction),i.setLogLevel(t.debug),i.supports.audioVideo||i.supports.data?i.validateId(e)?i.validateKey(t.key)?t.secure&&"0.peerjs.com"===t.host?void this._delayedAbort("ssl-unavailable","The cloud server currently does not support HTTPS. Please run your own PeerServer to use HTTPS."):(this.destroyed=!1,this.disconnected=!1,this.open=!1,this.connections={},this._lostMessages={},this._initializeServerConnection(),void(e?this._initialize(e):this._retrieveId())):void this._delayedAbort("invalid-key",'API KEY "'+t.key+'" is invalid'):void this._delayedAbort("invalid-id",'ID "'+e+'" is invalid'):void this._delayedAbort("browser-incompatible","The current browser does not support WebRTC")):new n(e,t)}var i=e("./util"),r=e("eventemitter3"),o=e("./socket"),s=e("./mediaconnection"),a=e("./dataconnection");i.inherits(n,r),n.prototype._initializeServerConnection=function(){var e=this;this.socket=new o(this.options.secure,this.options.host,this.options.port,this.options.path,this.options.key),this.socket.on("message",function(t){e._handleMessage(t)}),this.socket.on("error",function(t){e._abort("socket-error",t)}),this.socket.on("disconnected",function(){e.disconnected||(e.emitError("network","Lost connection to server."),e.disconnect())}),this.socket.on("close",function(){e.disconnected||e._abort("socket-closed","Underlying socket is already closed.")})},n.prototype._retrieveId=function(){var e=this,t=new XMLHttpRequest,n=this.options.secure?"https://":"http://",r=n+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/id",o="?ts="+(new Date).getTime()+Math.random();r+=o,t.open("get",r,!0),t.onerror=function(t){i.error("Error retrieving ID",t);var n="";"/"===e.options.path&&e.options.host!==i.CLOUD_HOST&&(n=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),e._abort("server-error","Could not get an ID from the server."+n)},t.onreadystatechange=function(){return 4===t.readyState?200!==t.status?void t.onerror():void e._initialize(t.responseText):void 0},t.send(null)},n.prototype._initialize=function(e){this.id=e,this.socket.start(this.id,this.options.token)},n.prototype._handleMessage=function(e){var t,n=e.type,r=e.payload,o=e.src;switch(n){case"OPEN":this.emit("open",this.id),this.open=!0;break;case"ERROR":this._abort("server-error",r.msg);break;case"ID-TAKEN":this._abort("unavailable-id","ID `"+this.id+"` is taken");break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this.options.key+'" is invalid');break;case"LEAVE":i.log("Received leave message from",o),this._cleanupPeer(o);break;case"EXPIRE":this.emitError("peer-unavailable","Could not connect to peer "+o);break;case"OFFER":var c=r.connectionId;if(t=this.getConnection(o,c))i.warn("Offer received for existing Connection ID:",c);else{if("media"===r.type)t=new s(o,this,{connectionId:c,_payload:r,metadata:r.metadata}),this._addConnection(o,t),this.emit("call",t);else{if("data"!==r.type)return void i.warn("Received malformed connection type:",r.type);t=new a(o,this,{connectionId:c,_payload:r,metadata:r.metadata,label:r.label,serialization:r.serialization,reliable:r.reliable}),this._addConnection(o,t),this.emit("connection",t)}for(var u=this._getMessages(c),h=0,p=u.length;p>h;h+=1)t.handleMessage(u[h])}break;default:if(!r)return void i.warn("You received a malformed message from "+o+" of type "+n);var l=r.connectionId;t=this.getConnection(o,l),t&&t.pc?t.handleMessage(e):l?this._storeMessage(l,e):i.warn("You received an unrecognized message:",e)}},n.prototype._storeMessage=function(e,t){this._lostMessages[e]||(this._lostMessages[e]=[]),this._lostMessages[e].push(t)},n.prototype._getMessages=function(e){var t=this._lostMessages[e];return t?(delete this._lostMessages[e],t):[]},n.prototype.connect=function(e,t){if(this.disconnected)return i.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");var n=new a(e,this,t);return this._addConnection(e,n),n},n.prototype.call=function(e,t,n){if(this.disconnected)return i.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");if(!t)return void i.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");n=n||{},n._stream=t;var r=new s(e,this,n);return this._addConnection(e,r),r},n.prototype._addConnection=function(e,t){this.connections[e]||(this.connections[e]=[]),this.connections[e].push(t)},n.prototype.getConnection=function(e,t){var n=this.connections[e];if(!n)return null;for(var i=0,r=n.length;r>i;i++)if(n[i].id===t)return n[i];return null},n.prototype._delayedAbort=function(e,t){var n=this;i.setZeroTimeout(function(){n._abort(e,t)})},n.prototype._abort=function(e,t){i.error("Aborting!"),this._lastServerId?this.disconnect():this.destroy(),this.emitError(e,t)},n.prototype.emitError=function(e,t){i.error("Error:",t),"string"==typeof t&&(t=new Error(t)),t.type=e,this.emit("error",t)},n.prototype.destroy=function(){this.destroyed||(this._cleanup(),this.disconnect(),this.destroyed=!0)},n.prototype._cleanup=function(){if(this.connections)for(var e=Object.keys(this.connections),t=0,n=e.length;n>t;t++)this._cleanupPeer(e[t]);this.emit("close")},n.prototype._cleanupPeer=function(e){for(var t=this.connections[e],n=0,i=t.length;i>n;n+=1)t[n].close()},n.prototype.disconnect=function(){var e=this;i.setZeroTimeout(function(){e.disconnected||(e.disconnected=!0,e.open=!1,e.socket&&e.socket.close(),e.emit("disconnected",e.id),e._lastServerId=e.id,e.id=null)})},n.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)i.log("Attempting reconnection to server with ID "+this._lastServerId),this.disconnected=!1,this._initializeServerConnection(),this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(this.disconnected||this.open)throw new Error("Peer "+this.id+" cannot reconnect because it is not disconnected from the server!");
i.error("In a hurry? We're still trying to make the initial connection!")}},n.prototype.listAllPeers=function(e){e=e||function(){};var t=this,n=new XMLHttpRequest,r=this.options.secure?"https://":"http://",o=r+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/peers",s="?ts="+(new Date).getTime()+Math.random();o+=s,n.open("get",o,!0),n.onerror=function(){t._abort("server-error","Could not get peers from the server."),e([])},n.onreadystatechange=function(){if(4===n.readyState){if(401===n.status){var r="";throw r=t.options.host!==i.CLOUD_HOST?"It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":"You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",e([]),new Error("It doesn't look like you have permission to list peers IDs. "+r)}e(200!==n.status?[]:JSON.parse(n.responseText))}},n.send(null)},t.exports=n},{"./dataconnection":2,"./mediaconnection":4,"./socket":7,"./util":8,eventemitter3:9}],7:[function(e,t){function n(e,t,i,o,s){if(!(this instanceof n))return new n(e,t,i,o,s);r.call(this),this.disconnected=!1,this._queue=[];var a=e?"https://":"http://",c=e?"wss://":"ws://";this._httpUrl=a+t+":"+i+o+s,this._wsUrl=c+t+":"+i+o+"peerjs?key="+s}var i=e("./util"),r=e("eventemitter3");i.inherits(n,r),n.prototype.start=function(e,t){this.id=e,this._httpUrl+="/"+e+"/"+t,this._wsUrl+="&id="+e+"&token="+t,this._startXhrStream(),this._startWebSocket()},n.prototype._startWebSocket=function(){var e=this;this._socket||(this._socket=new WebSocket(this._wsUrl),this._socket.onmessage=function(t){try{var n=JSON.parse(t.data)}catch(r){return void i.log("Invalid server message",t.data)}e.emit("message",n)},this._socket.onclose=function(){i.log("Socket closed."),e.disconnected=!0,e.emit("disconnected")},this._socket.onopen=function(){e._timeout&&(clearTimeout(e._timeout),setTimeout(function(){e._http.abort(),e._http=null},5e3)),e._sendQueuedMessages(),i.log("Socket open")})},n.prototype._startXhrStream=function(e){try{var t=this;this._http=new XMLHttpRequest,this._http._index=1,this._http._streamIndex=e||0,this._http.open("post",this._httpUrl+"/id?i="+this._http._streamIndex,!0),this._http.onerror=function(){clearTimeout(t._timeout),t.emit("disconnected")},this._http.onreadystatechange=function(){2==this.readyState&&this.old?(this.old.abort(),delete this.old):this.readyState>2&&200===this.status&&this.responseText&&t._handleStream(this)},this._http.send(null),this._setHTTPTimeout()}catch(n){i.log("XMLHttpRequest not available; defaulting to WebSockets")}},n.prototype._handleStream=function(e){var t=e.responseText.split("\n");if(e._buffer)for(;e._buffer.length>0;){var n=e._buffer.shift(),r=t[n];try{r=JSON.parse(r)}catch(o){e._buffer.shift(n);break}this.emit("message",r)}var s=t[e._index];if(s)if(e._index+=1,e._index===t.length)e._buffer||(e._buffer=[]),e._buffer.push(e._index-1);else{try{s=JSON.parse(s)}catch(o){return void i.log("Invalid server message",s)}this.emit("message",s)}},n.prototype._setHTTPTimeout=function(){var e=this;this._timeout=setTimeout(function(){var t=e._http;e._wsOpen()?t.abort():(e._startXhrStream(t._streamIndex+1),e._http.old=t)},25e3)},n.prototype._wsOpen=function(){return this._socket&&1==this._socket.readyState},n.prototype._sendQueuedMessages=function(){for(var e=0,t=this._queue.length;t>e;e+=1)this.send(this._queue[e])},n.prototype.send=function(e){if(!this.disconnected){if(!this.id)return void this._queue.push(e);if(!e.type)return void this.emit("error","Invalid message");var t=JSON.stringify(e);if(this._wsOpen())this._socket.send(t);else{var n=new XMLHttpRequest,i=this._httpUrl+"/"+e.type.toLowerCase();n.open("post",i,!0),n.setRequestHeader("Content-Type","application/json"),n.send(t)}}},n.prototype.close=function(){!this.disconnected&&this._wsOpen()&&(this._socket.close(),this.disconnected=!0)},t.exports=n},{"./util":8,eventemitter3:9}],8:[function(e,t){var n={iceServers:[{url:"stun:stun.l.google.com:19302"}]},i=1,r=e("js-binarypack"),o=e("./adapter").RTCPeerConnection,s={noop:function(){},CLOUD_HOST:"0.peerjs.com",CLOUD_PORT:9e3,chunkedBrowsers:{Chrome:1},chunkedMTU:16300,logLevel:0,setLogLevel:function(e){var t=parseInt(e,10);s.logLevel=isNaN(parseInt(e,10))?e?3:0:t,s.log=s.warn=s.error=s.noop,s.logLevel>0&&(s.error=s._printWith("ERROR")),s.logLevel>1&&(s.warn=s._printWith("WARNING")),s.logLevel>2&&(s.log=s._print)},setLogFunction:function(e){e.constructor!==Function?s.warn("The log function you passed in is not a function. Defaulting to regular logs."):s._print=e},_printWith:function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e),s._print.apply(s,t)}},_print:function(){var e=!1,t=Array.prototype.slice.call(arguments);t.unshift("PeerJS: ");for(var n=0,i=t.length;i>n;n++)t[n]instanceof Error&&(t[n]="("+t[n].name+") "+t[n].message,e=!0);e?console.error.apply(console,t):console.log.apply(console,t)},defaultConfig:n,browser:function(){return window.mozRTCPeerConnection?"Firefox":window.webkitRTCPeerConnection?"Chrome":window.RTCPeerConnection?"Supported":"Unsupported"}(),supports:function(){if("undefined"==typeof o)return{};var e,t,i=!0,r=!0,a=!1,c=!1,u=!!window.webkitRTCPeerConnection;try{e=new o(n,{optional:[{RtpDataChannels:!0}]})}catch(h){i=!1,r=!1}if(i)try{t=e.createDataChannel("_PEERJSTEST")}catch(h){i=!1}if(i){try{t.binaryType="blob",a=!0}catch(h){}var p=new o(n,{});try{var l=p.createDataChannel("_PEERJSRELIABLETEST",{});c=l.reliable}catch(h){}p.close()}if(r&&(r=!!e.addStream),!u&&i){var d=new o(n,{optional:[{RtpDataChannels:!0}]});d.onnegotiationneeded=function(){u=!0,s&&s.supports&&(s.supports.onnegotiationneeded=!0)},d.createDataChannel("_PEERJSNEGOTIATIONTEST"),setTimeout(function(){d.close()},1e3)}return e&&e.close(),{audioVideo:r,data:i,binaryBlob:a,binary:c,reliable:c,sctp:c,onnegotiationneeded:u}}(),validateId:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},validateKey:function(e){return!e||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(e)},debug:!1,inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:r.pack,unpack:r.unpack,log:function(){if(s.debug){var e=!1,t=Array.prototype.slice.call(arguments);t.unshift("PeerJS: ");for(var n=0,i=t.length;i>n;n++)t[n]instanceof Error&&(t[n]="("+t[n].name+") "+t[n].message,e=!0);e?console.error.apply(console,t):console.log.apply(console,t)}},setZeroTimeout:function(e){function t(t){i.push(t),e.postMessage(r,"*")}function n(t){t.source==e&&t.data==r&&(t.stopPropagation&&t.stopPropagation(),i.length&&i.shift()())}var i=[],r="zero-timeout-message";return e.addEventListener?e.addEventListener("message",n,!0):e.attachEvent&&e.attachEvent("onmessage",n),t}(window),chunk:function(e){for(var t=[],n=e.size,r=index=0,o=Math.ceil(n/s.chunkedMTU);n>r;){var a=Math.min(n,r+s.chunkedMTU),c=e.slice(r,a),u={__peerData:i,n:index,data:c,total:o};t.push(u),r=a,index+=1}return i+=1,t},blobToArrayBuffer:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsArrayBuffer(e)},blobToBinaryString:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=255&e.charCodeAt(n);return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isSecure:function(){return"https:"===location.protocol}};t.exports=s},{"./adapter":1,"js-binarypack":10}],9:[function(e,t){"use strict";function n(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function i(){}i.prototype._events=void 0,i.prototype.listeners=function(e){if(!this._events||!this._events[e])return[];for(var t=0,n=this._events[e].length,i=[];n>t;t++)i.push(this._events[e][t].fn);return i},i.prototype.emit=function(e,t,n,i,r,o){if(!this._events||!this._events[e])return!1;var s,a,c,u=this._events[e],h=u.length,p=arguments.length,l=u[0];if(1===h){switch(l.once&&this.removeListener(e,l.fn,!0),p){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,n),!0;case 4:return l.fn.call(l.context,t,n,i),!0;case 5:return l.fn.call(l.context,t,n,i,r),!0;case 6:return l.fn.call(l.context,t,n,i,r,o),!0}for(a=1,s=new Array(p-1);p>a;a++)s[a-1]=arguments[a];l.fn.apply(l.context,s)}else for(a=0;h>a;a++)switch(u[a].once&&this.removeListener(e,u[a].fn,!0),p){case 1:u[a].fn.call(u[a].context);break;case 2:u[a].fn.call(u[a].context,t);break;case 3:u[a].fn.call(u[a].context,t,n);break;default:if(!s)for(c=1,s=new Array(p-1);p>c;c++)s[c-1]=arguments[c];u[a].fn.apply(u[a].context,s)}return!0},i.prototype.on=function(e,t,i){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),this._events[e].push(new n(t,i||this)),this},i.prototype.once=function(e,t,i){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),this._events[e].push(new n(t,i||this,!0)),this},i.prototype.removeListener=function(e,t,n){if(!this._events||!this._events[e])return this;var i=this._events[e],r=[];if(t)for(var o=0,s=i.length;s>o;o++)i[o].fn!==t&&i[o].once!==n&&r.push(i[o]);return this._events[e]=r.length?r:null,this},i.prototype.removeAllListeners=function(e){return this._events?(e?this._events[e]=null:this._events={},this):this},i.prototype.off=i.prototype.removeListener,i.prototype.addListener=i.prototype.on,i.prototype.setMaxListeners=function(){return this},i.EventEmitter=i,i.EventEmitter2=i,i.EventEmitter3=i,"object"==typeof t&&t.exports&&(t.exports=i)},{}],10:[function(e,t){function n(e){this.index=0,this.dataBuffer=e,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function i(){this.bufferBuilder=new s}function r(e){var t=e.charCodeAt(0);return 2047>=t?"00":65535>=t?"000":2097151>=t?"0000":67108863>=t?"00000":"000000"}function o(e){return e.length>600?new Blob([e]).size:e.replace(/[^\u0000-\u007F]/g,r).length}var s=e("./bufferbuilder").BufferBuilder,a=e("./bufferbuilder").binaryFeatures,c={unpack:function(e){var t=new n(e);return t.unpack()},pack:function(e){var t=new i;t.pack(e);var n=t.getBuffer();return n}};t.exports=c,n.prototype.unpack=function(){var e=this.unpack_uint8();if(128>e){var t=e;return t}if(32>(224^e)){var n=(224^e)-32;return n}var i;if((i=160^e)<=15)return this.unpack_raw(i);if((i=176^e)<=15)return this.unpack_string(i);if((i=144^e)<=15)return this.unpack_array(i);if((i=128^e)<=15)return this.unpack_map(i);switch(e){case 192:return null;case 193:return void 0;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return void 0;case 213:return void 0;case 214:return void 0;case 215:return void 0;case 216:return i=this.unpack_uint16(),this.unpack_string(i);case 217:return i=this.unpack_uint32(),this.unpack_string(i);case 218:return i=this.unpack_uint16(),this.unpack_raw(i);case 219:return i=this.unpack_uint32(),this.unpack_raw(i);case 220:return i=this.unpack_uint16(),this.unpack_array(i);case 221:return i=this.unpack_uint32(),this.unpack_array(i);case 222:return i=this.unpack_uint16(),this.unpack_map(i);case 223:return i=this.unpack_uint32(),this.unpack_map(i)}},n.prototype.unpack_uint8=function(){var e=255&this.dataView[this.index];return this.index++,e},n.prototype.unpack_uint16=function(){var e=this.read(2),t=256*(255&e[0])+(255&e[1]);return this.index+=2,t},n.prototype.unpack_uint32=function(){var e=this.read(4),t=256*(256*(256*e[0]+e[1])+e[2])+e[3];return this.index+=4,t},n.prototype.unpack_uint64=function(){var e=this.read(8),t=256*(256*(256*(256*(256*(256*(256*e[0]+e[1])+e[2])+e[3])+e[4])+e[5])+e[6])+e[7];return this.index+=8,t},n.prototype.unpack_int8=function(){var e=this.unpack_uint8();return 128>e?e:e-256},n.prototype.unpack_int16=function(){var e=this.unpack_uint16();return 32768>e?e:e-65536},n.prototype.unpack_int32=function(){var e=this.unpack_uint32();return e<Math.pow(2,31)?e:e-Math.pow(2,32)},n.prototype.unpack_int64=function(){var e=this.unpack_uint64();return e<Math.pow(2,63)?e:e-Math.pow(2,64)},n.prototype.unpack_raw=function(e){if(this.length<this.index+e)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+e+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+e);return this.index+=e,t},n.prototype.unpack_string=function(e){for(var t,n,i=this.read(e),r=0,o="";e>r;)t=i[r],128>t?(o+=String.fromCharCode(t),r++):32>(192^t)?(n=(192^t)<<6|63&i[r+1],o+=String.fromCharCode(n),r+=2):(n=(15&t)<<12|(63&i[r+1])<<6|63&i[r+2],o+=String.fromCharCode(n),r+=3);return this.index+=e,o},n.prototype.unpack_array=function(e){for(var t=new Array(e),n=0;e>n;n++)t[n]=this.unpack();return t},n.prototype.unpack_map=function(e){for(var t={},n=0;e>n;n++){var i=this.unpack(),r=this.unpack();t[i]=r}return t},n.prototype.unpack_float=function(){var e=this.unpack_uint32(),t=e>>31,n=(e>>23&255)-127,i=8388607&e|8388608;return(0==t?1:-1)*i*Math.pow(2,n-23)},n.prototype.unpack_double=function(){var e=this.unpack_uint32(),t=this.unpack_uint32(),n=e>>31,i=(e>>20&2047)-1023,r=1048575&e|1048576,o=r*Math.pow(2,i-20)+t*Math.pow(2,i-52);return(0==n?1:-1)*o},n.prototype.read=function(e){var t=this.index;if(t+e<=this.length)return this.dataView.subarray(t,t+e);throw new Error("BinaryPackFailure: read index out of range")},i.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()},i.prototype.pack=function(e){var t=typeof e;if("string"==t)this.pack_string(e);else if("number"==t)Math.floor(e)===e?this.pack_integer(e):this.pack_double(e);else if("boolean"==t)e===!0?this.bufferBuilder.append(195):e===!1&&this.bufferBuilder.append(194);else if("undefined"==t)this.bufferBuilder.append(192);else{if("object"!=t)throw new Error('Type "'+t+'" not yet supported');if(null===e)this.bufferBuilder.append(192);else{var n=e.constructor;if(n==Array)this.pack_array(e);else if(n==Blob||n==File)this.pack_bin(e);else if(n==ArrayBuffer)this.pack_bin(a.useArrayBufferView?new Uint8Array(e):e);else if("BYTES_PER_ELEMENT"in e)this.pack_bin(a.useArrayBufferView?new Uint8Array(e.buffer):e.buffer);else if(n==Object)this.pack_object(e);else if(n==Date)this.pack_string(e.toString());else{if("function"!=typeof e.toBinaryPack)throw new Error('Type "'+n.toString()+'" not yet supported');this.bufferBuilder.append(e.toBinaryPack())}}}this.bufferBuilder.flush()},i.prototype.pack_bin=function(e){var t=e.length||e.byteLength||e.size;if(15>=t)this.pack_uint8(160+t);else if(65535>=t)this.bufferBuilder.append(218),this.pack_uint16(t);else{if(!(4294967295>=t))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(t)}this.bufferBuilder.append(e)},i.prototype.pack_string=function(e){var t=o(e);if(15>=t)this.pack_uint8(176+t);else if(65535>=t)this.bufferBuilder.append(216),this.pack_uint16(t);else{if(!(4294967295>=t))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(t)}this.bufferBuilder.append(e)},i.prototype.pack_array=function(e){var t=e.length;if(15>=t)this.pack_uint8(144+t);else if(65535>=t)this.bufferBuilder.append(220),this.pack_uint16(t);else{if(!(4294967295>=t))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(t)}for(var n=0;t>n;n++)this.pack(e[n])},i.prototype.pack_integer=function(e){if(e>=-32&&127>=e)this.bufferBuilder.append(255&e);else if(e>=0&&255>=e)this.bufferBuilder.append(204),this.pack_uint8(e);else if(e>=-128&&127>=e)this.bufferBuilder.append(208),this.pack_int8(e);else if(e>=0&&65535>=e)this.bufferBuilder.append(205),this.pack_uint16(e);else if(e>=-32768&&32767>=e)this.bufferBuilder.append(209),this.pack_int16(e);else if(e>=0&&4294967295>=e)this.bufferBuilder.append(206),this.pack_uint32(e);else if(e>=-2147483648&&2147483647>=e)this.bufferBuilder.append(210),this.pack_int32(e);else if(e>=-0x8000000000000000&&0x8000000000000000>=e)this.bufferBuilder.append(211),this.pack_int64(e);else{if(!(e>=0&&0x10000000000000000>=e))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(e)}},i.prototype.pack_double=function(e){var t=0;0>e&&(t=1,e=-e);var n=Math.floor(Math.log(e)/Math.LN2),i=e/Math.pow(2,n)-1,r=Math.floor(i*Math.pow(2,52)),o=Math.pow(2,32),s=t<<31|n+1023<<20|r/o&1048575,a=r%o;this.bufferBuilder.append(203),this.pack_int32(s),this.pack_int32(a)},i.prototype.pack_object=function(e){var t=Object.keys(e),n=t.length;if(15>=n)this.pack_uint8(128+n);else if(65535>=n)this.bufferBuilder.append(222),this.pack_uint16(n);else{if(!(4294967295>=n))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(n)}for(var i in e)e.hasOwnProperty(i)&&(this.pack(i),this.pack(e[i]))},i.prototype.pack_uint8=function(e){this.bufferBuilder.append(e)},i.prototype.pack_uint16=function(e){this.bufferBuilder.append(e>>8),this.bufferBuilder.append(255&e)},i.prototype.pack_uint32=function(e){var t=4294967295&e;this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t)},i.prototype.pack_uint64=function(e){var t=e/Math.pow(2,32),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)},i.prototype.pack_int8=function(e){this.bufferBuilder.append(255&e)},i.prototype.pack_int16=function(e){this.bufferBuilder.append((65280&e)>>8),this.bufferBuilder.append(255&e)},i.prototype.pack_int32=function(e){this.bufferBuilder.append(e>>>24&255),this.bufferBuilder.append((16711680&e)>>>16),this.bufferBuilder.append((65280&e)>>>8),this.bufferBuilder.append(255&e)},i.prototype.pack_int64=function(e){var t=Math.floor(e/Math.pow(2,32)),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)}},{"./bufferbuilder":11}],11:[function(e,t){function n(){this._pieces=[],this._parts=[]}var i={};i.useBlobBuilder=function(){try{return new Blob([]),!1}catch(e){return!0}}(),i.useArrayBufferView=!i.useBlobBuilder&&function(){try{return 0===new Blob([new Uint8Array([])]).size}catch(e){return!0}}(),t.exports.binaryFeatures=i;var r=t.exports.BlobBuilder;"undefined"!=typeof window&&(r=t.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder),n.prototype.append=function(e){"number"==typeof e?this._pieces.push(e):(this.flush(),this._parts.push(e))},n.prototype.flush=function(){if(this._pieces.length>0){var e=new Uint8Array(this._pieces);i.useArrayBufferView||(e=e.buffer),this._parts.push(e),this._pieces=[]}},n.prototype.getBuffer=function(){if(this.flush(),i.useBlobBuilder){for(var e=new r,t=0,n=this._parts.length;n>t;t++)e.append(this._parts[t]);return e.getBlob()}return new Blob(this._parts)},t.exports.BufferBuilder=n},{}],12:[function(e,t){function n(e,t){return this instanceof n?(this._dc=e,i.debug=t,this._outgoing={},this._incoming={},this._received={},this._window=1e3,this._mtu=500,this._interval=0,this._count=0,this._queue=[],void this._setupDC()):new n(e)}var i=e("./util");n.prototype.send=function(e){var t=i.pack(e);return t.size<this._mtu?void this._handleSend(["no",t]):(this._outgoing[this._count]={ack:0,chunks:this._chunk(t)},i.debug&&(this._outgoing[this._count].timer=new Date),this._sendWindowedChunks(this._count),void(this._count+=1))},n.prototype._setupInterval=function(){var e=this;this._timeout=setInterval(function(){var t=e._queue.shift();if(t._multiple)for(var n=0,i=t.length;i>n;n+=1)e._intervalSend(t[n]);else e._intervalSend(t)},this._interval)},n.prototype._intervalSend=function(e){var t=this;e=i.pack(e),i.blobToBinaryString(e,function(e){t._dc.send(e)}),0===t._queue.length&&(clearTimeout(t._timeout),t._timeout=null)},n.prototype._processAcks=function(){for(var e in this._outgoing)this._outgoing.hasOwnProperty(e)&&this._sendWindowedChunks(e)},n.prototype._handleSend=function(e){for(var t=!0,n=0,i=this._queue.length;i>n;n+=1){var r=this._queue[n];r===e?t=!1:r._multiple&&-1!==r.indexOf(e)&&(t=!1)}t&&(this._queue.push(e),this._timeout||this._setupInterval())},n.prototype._setupDC=function(){var e=this;this._dc.onmessage=function(t){var n=t.data,r=n.constructor;if(r===String){var o=i.binaryStringToArrayBuffer(n);n=i.unpack(o),e._handleMessage(n)}}},n.prototype._handleMessage=function(e){var t,n=e[1],r=this._incoming[n],o=this._outgoing[n];switch(e[0]){case"no":var s=n;s&&this.onmessage(i.unpack(s));break;case"end":if(t=r,this._received[n]=e[2],!t)break;this._ack(n);break;case"ack":if(t=o){var a=e[2];t.ack=Math.max(a,t.ack),t.ack>=t.chunks.length?(i.log("Time: ",new Date-t.timer),delete this._outgoing[n]):this._processAcks()}break;case"chunk":if(t=r,!t){var c=this._received[n];if(c===!0)break;t={ack:["ack",n,0],chunks:[]},this._incoming[n]=t}var u=e[2],h=e[3];t.chunks[u]=new Uint8Array(h),u===t.ack[2]&&this._calculateNextAck(n),this._ack(n);break;default:this._handleSend(e)}},n.prototype._chunk=function(e){for(var t=[],n=e.size,r=0;n>r;){var o=Math.min(n,r+this._mtu),s=e.slice(r,o),a={payload:s};t.push(a),r=o}return i.log("Created",t.length,"chunks."),t},n.prototype._ack=function(e){var t=this._incoming[e].ack;this._received[e]===t[2]&&(this._complete(e),this._received[e]=!0),this._handleSend(t)},n.prototype._calculateNextAck=function(e){for(var t=this._incoming[e],n=t.chunks,i=0,r=n.length;r>i;i+=1)if(void 0===n[i])return void(t.ack[2]=i);t.ack[2]=n.length},n.prototype._sendWindowedChunks=function(e){i.log("sendWindowedChunks for: ",e);for(var t=this._outgoing[e],n=t.chunks,r=[],o=Math.min(t.ack+this._window,n.length),s=t.ack;o>s;s+=1)n[s].sent&&s!==t.ack||(n[s].sent=!0,r.push(["chunk",e,s,n[s].payload]));t.ack+this._window>=n.length&&r.push(["end",e,n.length]),r._multiple=!0,this._handleSend(r)},n.prototype._complete=function(e){i.log("Completed called for",e);var t=this,n=this._incoming[e].chunks,r=new Blob(n);i.blobToArrayBuffer(r,function(e){t.onmessage(i.unpack(e))}),delete this._incoming[e]},n.higherBandwidthSDP=function(e){var t=navigator.appVersion.match(/Chrome\/(.*?) /);if(t&&(t=parseInt(t[1].split(".").shift()),31>t)){var n=e.split("b=AS:30"),i="b=AS:102400";if(n.length>1)return n[0]+i+n[1]}return e},n.prototype.onmessage=function(){},t.exports.Reliable=n},{"./util":13}],13:[function(e,t){var n=e("js-binarypack"),i={debug:!1,inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:n.pack,unpack:n.unpack,log:function(){if(i.debug){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];e.unshift("Reliable: "),console.log.apply(console,e)}},setZeroTimeout:function(e){function t(t){i.push(t),e.postMessage(r,"*")}function n(t){t.source==e&&t.data==r&&(t.stopPropagation&&t.stopPropagation(),i.length&&i.shift()())}var i=[],r="zero-timeout-message";return e.addEventListener?e.addEventListener("message",n,!0):e.attachEvent&&e.attachEvent("onmessage",n),t}(this),blobToArrayBuffer:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsArrayBuffer(e)},blobToBinaryString:function(e,t){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsBinaryString(e)},binaryStringToArrayBuffer:function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=255&e.charCodeAt(n);return t.buffer},randomToken:function(){return Math.random().toString(36).substr(2)}};t.exports=i},{"js-binarypack":10}]},{},[3]),RC4.getStringBytes=function(e){for(var t=[],n=0;n<e.length;n++){var i=e.charCodeAt(n),r=[];do r.push(255&i),i>>=8;while(i>0);t=t.concat(r.reverse())}return t},RC4.prototype._swap=function(e,t){var n=this.s[e];this.s[e]=this.s[t],this.s[t]=n},RC4.prototype.mix=function(e){for(var t=RC4.getStringBytes(e),n=0,i=0;i<this.s.length;i++)n+=this.s[i]+t[i%t.length],n%=256,this._swap(i,n)},RC4.prototype.next=function(){return this.i=(this.i+1)%256,this.j=(this.j+this.s[this.i])%256,this._swap(this.i,this.j),this.s[(this.s[this.i]+this.s[this.j])%256]},RNG.prototype.nextByte=function(){return this._state.next()},RNG.prototype.uniform=function(){for(var e=7,t=0,n=0;e>n;n++)t*=256,t+=this.nextByte();return t/(Math.pow(2,8*e)-1)},RNG.prototype.random=function(e,t){return null==e?this.uniform():(null==t&&(t=e,e=0),e+Math.floor(this.uniform()*(t-e)))},RNG.prototype.normal=function(){if(null!==this._normal){var e=this._normal;return this._normal=null,e}var t=this.uniform()||Math.pow(2,-53),n=this.uniform();return this._normal=Math.sqrt(-2*Math.log(t))*Math.sin(2*Math.PI*n),Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*n)},RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))},RNG.prototype.poisson=function(e){var t=Math.exp(-(e||1)),n=0,i=1;do n++,i*=this.uniform();while(i>t);return n-1},RNG.prototype.gamma=function(e){var t=(1>e?1+e:e)-1/3,n=1/Math.sqrt(9*t);do{do var i=this.normal(),r=Math.pow(n*i+1,3);while(0>=r);var o=this.uniform(),s=Math.pow(i,2)}while(o>=1-.0331*s*s&&Math.log(o)>=.5*s+t*(1-r+Math.log(r)));return 1>e?t*r*Math.exp(this.exponential()/-e):t*r},RNG.roller=function(e,t){var n=e.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),i=parseFloat(n[0])||1,r=parseFloat(n[1]),o=parseFloat(n[2])||0;return t=t||new RNG,function(){for(var e=i+o,n=0;i>n;n++)e+=t.random(r);return e}},RNG.$=new RNG;